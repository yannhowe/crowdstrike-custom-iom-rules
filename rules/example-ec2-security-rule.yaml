# CrowdStrike Custom IOM Rule - EC2 Security Compliance
# This is a complete, self-contained rule definition with embedded Rego logic
# File: example-ec2-security-rule.yaml

rule:
  # Basic Rule Information
  name: "EC2-Security-Compliance-Policy"
  description: "Comprehensive EC2 security compliance check ensuring proper tagging, security groups, and instance configuration"
  
  # Resource Target Configuration
  resource_type: "AWS::EC2::Instance"
  platform: "AWS"
  provider: "AWS"
  
  # Rule Classification
  domain: "CSPM"
  subdomain: "IOM"
  severity: 1  # 0=Critical, 1=High, 2=Medium, 3=Informational
  
  # Complete Rego Logic - Everything embedded in this file
  logic: |
    package crowdstrike
    
    # =============================================================================
    # CONSTANTS AND CONFIGURATION
    # =============================================================================
    
    # Valid environment values for the Environment tag
    valid_environments := ["dev", "staging", "prod"]
    
    # Required tags for all EC2 instances
    required_tags := ["Environment", "Owner", "Project", "CostCenter"]
    
    # Allowed instance types (security-approved)
    allowed_instance_types := [
        "t3.micro", "t3.small", "t3.medium",
        "t3a.micro", "t3a.small", "t3a.medium",
        "m5.large", "m5.xlarge",
        "c5.large", "c5.xlarge"
    ]
    
    # =============================================================================
    # HELPER FUNCTIONS
    # =============================================================================
    
    # Check if all required tags exist
    has_all_required_tags if {
        count([tag | tag := required_tags[_]; input.resource.tags[tag]]) == count(required_tags)
    }
    
    # Validate environment tag value
    valid_environment_tag if {
        input.resource.tags.Environment in valid_environments
    }
    
    # Check if instance type is approved
    approved_instance_type if {
        input.resource.instance_type in allowed_instance_types
    }
    
    # Check if instance is in running state
    instance_running if {
        input.resource.state == "running"
    }
    
    # Check if instance has proper security group (not default)
    proper_security_groups if {
        count(input.resource.security_groups) > 0
        not "default" in [sg.group_name | sg := input.resource.security_groups[_]]
    }
    
    # Check if instance has monitoring enabled
    monitoring_enabled if {
        input.resource.monitoring.state == "enabled"
    }
    
    # =============================================================================
    # MAIN RULE LOGIC
    # =============================================================================
    
    # Default result - rule fails unless all conditions are met
    default result = "fail"
    
    # Rule passes if ALL security requirements are satisfied
    result = "pass" if {
        has_all_required_tags
        valid_environment_tag
        approved_instance_type
        instance_running
        proper_security_groups
        monitoring_enabled
    }
    
    # =============================================================================
    # DETAILED VIOLATION MESSAGES
    # =============================================================================
    
    # Missing required tags violation
    violation contains {"msg": msg} if {
        not has_all_required_tags
        missing_tags := [tag | tag := required_tags[_]; not input.resource.tags[tag]]
        msg := sprintf("EC2 instance is missing required tags: %v. All instances must have: %v", [missing_tags, required_tags])
    }
    
    # Invalid environment tag violation
    violation contains {"msg": msg} if {
        input.resource.tags.Environment
        not valid_environment_tag
        msg := sprintf("Environment tag value '%v' is invalid. Must be one of: %v", [input.resource.tags.Environment, valid_environments])
    }
    
    # Unapproved instance type violation
    violation contains {"msg": msg} if {
        not approved_instance_type
        msg := sprintf("Instance type '%v' is not approved. Allowed types: %v", [input.resource.instance_type, allowed_instance_types])
    }
    
    # Instance not running violation
    violation contains {"msg": msg} if {
        not instance_running
        msg := sprintf("Instance state is '%v' but should be 'running' for compliance", [input.resource.state])
    }
    
    # Security group violations
    violation contains {"msg": msg} if {
        not proper_security_groups
        count(input.resource.security_groups) == 0
        msg := "Instance must be associated with at least one security group"
    }
    
    violation contains {"msg": msg} if {
        not proper_security_groups
        "default" in [sg.group_name | sg := input.resource.security_groups[_]]
        msg := "Instance must not use the default security group. Create and assign a custom security group"
    }
    
    # Monitoring not enabled violation
    violation contains {"msg": msg} if {
        not monitoring_enabled
        msg := sprintf("CloudWatch monitoring is '%v' but must be 'enabled' for security compliance", [input.resource.monitoring.state])
    }
  
  # Alert and Remediation Information
  alert_info: "This rule validates comprehensive EC2 security compliance including proper tagging, approved instance types, security groups, and monitoring configuration"
  
  remediation: |
    To resolve violations, ensure your EC2 instance meets these requirements:
    1. Add all required tags: Environment, Owner, Project, CostCenter
    2. Set Environment tag to: dev, staging, or prod
    3. Use only approved instance types (t3, t3a, m5, c5 families)
    4. Ensure instance is in 'running' state
    5. Remove default security group and use custom security groups
    6. Enable CloudWatch monitoring
  
  # Attack Types and Compliance Controls
  attack_types:
    - "Resource Mismanagement"
    - "Governance Violation"
    - "Security Group Misconfiguration"
    - "Monitoring Evasion"
  
  # Note: Controls format simplified to avoid JSON marshaling issues
  # The API expects an empty array for controls in the current implementation
  controls: []

# Testing Configuration
testing:
  # Sample resource IDs for testing (replace with actual IDs from your environment)
  sample_resource_ids:
    - "i-1234567890abcdef0"  # Compliant instance
    - "i-0987654321fedcba0"  # Non-compliant instance
  
  # Expected test results
  expected_results:
    pass:
      - resource_id: "i-compliant-instance"
        reason: "Has all required tags, approved instance type, proper security groups, and monitoring enabled"
        tags:
          Environment: "prod"
          Owner: "security-team"
          Project: "web-app"
          CostCenter: "engineering"
        instance_type: "t3.medium"
        state: "running"
        monitoring: "enabled"
    
    fail:
      - resource_id: "i-missing-tags"
        reason: "Missing required tags"
        violations: ["Missing Environment tag", "Missing Owner tag"]
      
      - resource_id: "i-wrong-instance-type"
        reason: "Using unapproved instance type"
        instance_type: "t2.large"
        violations: ["Instance type 't2.large' is not approved"]
      
      - resource_id: "i-default-sg"
        reason: "Using default security group"
        violations: ["Must not use default security group"]

# Rule Metadata for Management
metadata:
  version: "1.2.0"
  author: "Security Engineering Team"
  created: "2024-01-15"
  last_modified: "2024-01-20"
  tags: ["ec2", "security", "compliance", "tagging", "monitoring"]
  category: "Infrastructure Security"
  
  # Change log
  changelog:
    - version: "1.0.0"
      date: "2024-01-15"
      changes: "Initial rule creation"
    - version: "1.1.0"
      date: "2024-01-18"
      changes: "Added monitoring requirement"
    - version: "1.2.0"
      date: "2024-01-20"
      changes: "Enhanced security group validation"

# Deployment Configuration
deployment:
  environments:
    - name: "staging"
      enabled: true
      test_mode: true
    - name: "production"
      enabled: true
      test_mode: false
  
  # Rollout strategy
  rollout:
    strategy: "gradual"
    percentage: 25  # Start with 25% of resources
    duration: "7d"  # Increase over 7 days