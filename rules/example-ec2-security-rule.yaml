# CrowdStrike Custom IOM Rule - EC2 Security Compliance
# Minimal example showing only required fields for CrowdStrike API

rule:
  # Required Basic Information
  name: "EC2-Security-Compliance-Policy"
  description: "Comprehensive EC2 security compliance check ensuring proper tagging, security groups, and instance configuration"
  
  # Required Resource Configuration
  resource_type: "AWS::EC2::Instance"
  platform: "AWS"
  provider: "AWS"
  
  # Required Classification (these are the defaults)
  domain: "CSPM"
  subdomain: "IOM"
  severity: 1  # 0=Critical, 1=High, 2=Medium, 3=Informational
  
  # Required Rego Logic
  logic: |
    package crowdstrike
    
    # Valid environment values for the Environment tag
    valid_environments := ["dev", "staging", "prod"]
    
    # Required tags for all EC2 instances
    required_tags := ["Environment", "Owner", "Project"]
    
    # Allowed instance types (security-approved)
    allowed_instance_types := [
        "t3.micro", "t3.small", "t3.medium",
        "m5.large", "m5.xlarge",
        "c5.large", "c5.xlarge"
    ]
    
    # Check if all required tags exist
    has_all_required_tags if {
        count([tag | tag := required_tags[_]; input.resource.tags[tag]]) == count(required_tags)
    }
    
    # Validate environment tag value
    valid_environment_tag if {
        input.resource.tags.Environment in valid_environments
    }
    
    # Check if instance type is approved
    approved_instance_type if {
        input.resource.instance_type in allowed_instance_types
    }
    
    # Check if instance has proper security group (not default)
    proper_security_groups if {
        count(input.resource.security_groups) > 0
        not "default" in [sg.group_name | sg := input.resource.security_groups[_]]
    }
    
    # Default result - rule fails unless all conditions are met
    default result = "fail"
    
    # Rule passes if ALL security requirements are satisfied
    result = "pass" if {
        has_all_required_tags
        valid_environment_tag
        approved_instance_type
        input.resource.state == "running"
        proper_security_groups
    }
    
    # Violation messages for debugging
    violation contains {"msg": msg} if {
        not has_all_required_tags
        missing_tags := [tag | tag := required_tags[_]; not input.resource.tags[tag]]
        msg := sprintf("Missing required tags: %v", [missing_tags])
    }
    
    violation contains {"msg": msg} if {
        not valid_environment_tag
        msg := sprintf("Environment tag '%v' must be one of: %v", [input.resource.tags.Environment, valid_environments])
    }
    
    violation contains {"msg": msg} if {
        not approved_instance_type
        msg := sprintf("Instance type '%v' not approved. Allowed: %v", [input.resource.instance_type, allowed_instance_types])
    }
    
    violation contains {"msg": msg} if {
        not input.resource.state == "running"
        msg := sprintf("Instance state '%v' must be 'running'", [input.resource.state])
    }
    
    violation contains {"msg": msg} if {
        not proper_security_groups
        msg := "Instance must not use default security group"
    }
  
  # Optional but recommended fields
  alert_info: "Validates EC2 security compliance including tagging, instance types, and security groups"
  remediation: "Ensure instance has required tags (Environment, Owner, Project), uses approved instance type, is running, and doesn't use default security group"

# Optional: Testing configuration (not sent to API, used by rule-manager.py for testing)
testing:
  sample_resource_ids:
    - "i-1234567890abcdef0"  # Replace with actual instance ID for testing

# Optional: Metadata (not sent to API, for documentation only)
metadata:
  version: "1.0"
  author: "Security Team"